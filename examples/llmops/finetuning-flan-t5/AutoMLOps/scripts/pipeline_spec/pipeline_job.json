{
  "pipelineSpec": {
    "components": {
      "comp-deploy-and-test-model": {
        "executorLabel": "exec-deploy-and-test-model",
        "inputDefinitions": {
          "parameters": {
            "endpoint_sa": {
              "type": "STRING"
            },
            "project_id": {
              "type": "STRING"
            },
            "region": {
              "type": "STRING"
            },
            "serving_image_tag": {
              "type": "STRING"
            }
          }
        }
      },
      "comp-finetune-t5-model": {
        "executorLabel": "exec-finetune-t5-model",
        "inputDefinitions": {
          "parameters": {
            "base_output_directory": {
              "type": "STRING"
            },
            "display_name": {
              "type": "STRING"
            },
            "enable_web_access": {
              "type": "STRING"
            },
            "encryption_spec_key_name": {
              "type": "STRING"
            },
            "epochs": {
              "type": "INT"
            },
            "eval_batch": {
              "type": "INT"
            },
            "labels": {
              "type": "STRING"
            },
            "location": {
              "type": "STRING"
            },
            "logging_steps": {
              "type": "INT"
            },
            "lr": {
              "type": "DOUBLE"
            },
            "model_dir": {
              "type": "STRING"
            },
            "network": {
              "type": "STRING"
            },
            "project": {
              "type": "STRING"
            },
            "reserved_ip_ranges": {
              "type": "STRING"
            },
            "restart_job_on_worker_restart": {
              "type": "STRING"
            },
            "service_account": {
              "type": "STRING"
            },
            "tensorboard": {
              "type": "STRING"
            },
            "timeout": {
              "type": "STRING"
            },
            "train_batch": {
              "type": "INT"
            },
            "worker_pool_specs": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "parameters": {
            "gcp_resources": {
              "type": "STRING"
            }
          }
        }
      }
    },
    "deploymentSpec": {
      "executors": {
        "exec-deploy-and-test-model": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "deploy_and_test_model"
            ],
            "command": [
              "python3",
              "/pipelines/component/src/deploy_and_test_model.py"
            ],
            "image": "us-central1-docker.pkg.dev/automlops-sandbox/vertex-mlops-af/components/component_base:latest"
          }
        },
        "exec-finetune-t5-model": {
          "container": {
            "args": [
              "--type",
              "CustomJob",
              "--payload",
              "{\"display_name\": \"{{$.inputs.parameters['display_name']}}\", \"job_spec\": {\"worker_pool_specs\": {{$.inputs.parameters['worker_pool_specs']}}, \"scheduling\": {\"timeout\": \"{{$.inputs.parameters['timeout']}}\", \"restart_job_on_worker_restart\": \"{{$.inputs.parameters['restart_job_on_worker_restart']}}\"}, \"service_account\": \"{{$.inputs.parameters['service_account']}}\", \"tensorboard\": \"{{$.inputs.parameters['tensorboard']}}\", \"enable_web_access\": \"{{$.inputs.parameters['enable_web_access']}}\", \"network\": \"{{$.inputs.parameters['network']}}\", \"reserved_ip_ranges\": {{$.inputs.parameters['reserved_ip_ranges']}}, \"base_output_directory\": {\"output_uri_prefix\": \"{{$.inputs.parameters['base_output_directory']}}\"}}, \"labels\": {{$.inputs.parameters['labels']}}, \"encryption_spec\": {\"kms_key_name\":\"{{$.inputs.parameters['encryption_spec_key_name']}}\"}}",
              "--project",
              "{{$.inputs.parameters['project']}}",
              "--location",
              "{{$.inputs.parameters['location']}}",
              "--gcp_resources",
              "{{$.outputs.parameters['gcp_resources'].output_file}}"
            ],
            "command": [
              "python3",
              "-u",
              "-m",
              "google_cloud_pipeline_components.container.v1.custom_job.launcher"
            ],
            "image": "gcr.io/ml-pipeline/google-cloud-pipeline-components:1.0.38"
          }
        }
      }
    },
    "pipelineInfo": {
      "name": "finetune-flan-t5-pipeline"
    },
    "root": {
      "dag": {
        "tasks": {
          "deploy-and-test-model": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-deploy-and-test-model"
            },
            "dependentTasks": [
              "finetune-t5-model"
            ],
            "inputs": {
              "parameters": {
                "endpoint_sa": {
                  "componentInputParameter": "endpoint_sa"
                },
                "project_id": {
                  "componentInputParameter": "project_id"
                },
                "region": {
                  "componentInputParameter": "region"
                },
                "serving_image_tag": {
                  "componentInputParameter": "serving_image_tag"
                }
              }
            },
            "taskInfo": {
              "name": "deploy-and-test-model"
            }
          },
          "finetune-t5-model": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-finetune-t5-model"
            },
            "inputs": {
              "parameters": {
                "base_output_directory": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "gs://automlops-sandbox-bucket/finetune_t5_model"
                    }
                  }
                },
                "display_name": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "flan-t5-base-finetuning-gpu-tensorboard"
                    }
                  }
                },
                "enable_web_access": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "false"
                    }
                  }
                },
                "encryption_spec_key_name": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": ""
                    }
                  }
                },
                "epochs": {
                  "componentInputParameter": "epochs"
                },
                "eval_batch": {
                  "componentInputParameter": "eval_batch"
                },
                "labels": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "{}"
                    }
                  }
                },
                "location": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "us-central1"
                    }
                  }
                },
                "logging_steps": {
                  "componentInputParameter": "logging_steps"
                },
                "lr": {
                  "componentInputParameter": "lr"
                },
                "model_dir": {
                  "componentInputParameter": "model_dir"
                },
                "network": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": ""
                    }
                  }
                },
                "project": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "automlops-sandbox"
                    }
                  }
                },
                "reserved_ip_ranges": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "[]"
                    }
                  }
                },
                "restart_job_on_worker_restart": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "false"
                    }
                  }
                },
                "service_account": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "vertex-pipelines@automlops-sandbox.iam.gserviceaccount.com"
                    }
                  }
                },
                "tensorboard": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "projects/45373616427/locations/us-central1/tensorboards/7551190772867923968"
                    }
                  }
                },
                "timeout": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "604800s"
                    }
                  }
                },
                "train_batch": {
                  "componentInputParameter": "train_batch"
                },
                "worker_pool_specs": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "[{\"machine_spec\": {\"machine_type\": \"n1-standard-32\", \"accelerator_type\": \"NVIDIA_TESLA_V100\", \"accelerator_count\": \"4\"}, \"replica_count\": 1, \"container_spec\": {\"image_uri\": \"us-central1-docker.pkg.dev/automlops-sandbox/vertex-mlops-af/components/component_base:latest\", \"command\": [\"python3\", \"/pipelines/component/src/finetune_t5_model.py\"], \"args\": [\"--executor_input\", \"{{$.json_escape[1]}}\", \"--function_to_execute\", \"finetune_t5_model\"]}, \"disk_spec\": {\"boot_disk_type\": \"pd-ssd\", \"boot_disk_size_gb\": 100}}]"
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "finetune-t5-model"
            }
          }
        }
      },
      "inputDefinitions": {
        "parameters": {
          "endpoint_sa": {
            "type": "STRING"
          },
          "epochs": {
            "type": "INT"
          },
          "eval_batch": {
            "type": "INT"
          },
          "logging_steps": {
            "type": "INT"
          },
          "lr": {
            "type": "DOUBLE"
          },
          "model_dir": {
            "type": "STRING"
          },
          "project_id": {
            "type": "STRING"
          },
          "region": {
            "type": "STRING"
          },
          "serving_image_tag": {
            "type": "STRING"
          },
          "train_batch": {
            "type": "INT"
          }
        }
      }
    },
    "schemaVersion": "2.0.0",
    "sdkVersion": "kfp-1.8.18"
  },
  "runtimeConfig": {}
}